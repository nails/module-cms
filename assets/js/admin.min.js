(()=>{"use strict";window.NAILS.ADMIN.registerPlugin("nails/module-cms","WidgetEditor",(function(t){return new class{constructor(t){this.adminController=t,this.adminController.log("Constructing"),this.instantiated=!1,this.$btns=$(".open-editor").addClass("processed"),this.setupListeners(),this.adminController.onRefreshUi(((t,e)=>{this.instantiated?this.initNewButtons(e):this.init()}))}init(){return this.adminController.log("Initialising Widget Editor"),this.instantiated=!0,this.$btns.prop("disabled",!0),this.isEditorReady=!1,this.isEditorOpen=!1,this.widgets=[],this.actions=[{label:'<i class="fa fa-lg fa-check"></i>',type:"success",callback:()=>{this.actionClose()}}],this.widgetData={},this.container=null,this.sections={},this.activeArea="",this.activeButton=null,this.defaultArea="default",this.searchTimeout=null,this.searchDelay=150,this.keymap={ESC:27},this.widgetInitCallback=[],this.generateMarkup(),this.bindEvents(),this.loadSidebarWidgets().done((()=>{this.renderSidebarWidgets(),this.isEditorReady=!0,this.adminController.log("Widget Editor ready"),$(this).trigger("widgeteditor-ready")})),this.addWidgetInitCallback((t=>{this.adminController.refreshUi()})),this.populateWidgetDataFromButtons(this.$btns),this}initNewButtons(t){let e=$(".open-editor:not(.processed)",t).addClass("processed");if(e.length){this.adminController.log(`Found ${e.length} new buttons`),this.setupButtonListeners(e).populateWidgetDataFromButtons(e);for(let t=0;t<e.length;t++)this.$btns.push(e[t])}}setupListeners(){this.adminController.log("Setting up listeners"),this.setupButtonListeners(this.$btns),this.setupGlobalListeners()}setupGlobalListeners(){return $(this).on("widgeteditor-ready",(()=>{this.$btns.prop("disabled",!1)})).on("widgeteditor-close",(()=>{if(this.activeButton){this.adminController.log("Editor Closing, getting area data and saving to input");let t=this.activeButton.siblings("textarea.widget-data"),e=this.getAreaData(this.activeButton.data("key")),i=JSON.stringify(e);t.length&&t.val(i).trigger("change")}})),this}setupButtonListeners(t){return t.on("click",(t=>{if(this.isReady()){this.activeButton=$(t.currentTarget);let e=this.activeButton.data("key");this.adminController.log("Opening Editor for area: "+e),this.show(e)}else this.adminController.warn("Widget editor not ready");return!1})),this}generateMarkup(){let t;return null===this.container?(this.adminController.log("Injecting editor markup"),this.container=$("<div>").addClass("group-cms widgeteditor"),this.sections={header:$("<div>").addClass("widgeteditor-header").text("Some header text, maybe"),actions:$("<div>").addClass("widgeteditor-actions"),search:$("<div>").addClass("widgeteditor-search"),widgets:$("<div>").addClass("widgeteditor-widgets"),body:$("<div>").addClass("widgeteditor-body").html('<ul></ul><div class="no-widgets">Drag widgets from the left to here</div>'),widget:$("<div>").html('<i class="icon fa {{icon}}"></i><span>{{label}}</span><a href="#" class="action action-remove fa fa-trash"></a><a href="#" class="action action-refresh-editor fa fa-sync"></a><div class="description">{{description}}</div><div class="editor-target fieldset">Widget Loading...</div>'),preview:$("<div>").addClass("widgeteditor-preview").html('<img width="250"><small></small>')},t=$("<input>").attr("type","search").attr("placeholder","Search widgets"),this.sections.search.append(t),this.container.append(this.sections.header).append(this.sections.actions).append(this.sections.search).append(this.sections.widgets).append(this.sections.body).append(this.sections.preview),$("body").append(this.container),this.renderSidebarWidgets(),this.renderActions()):this.adminController.warn("Editor already generated"),this}bindEvents(){let t,e;return this.sections.actions.on("click",".action",(e=>{let i=$(e.currentTarget);return t=i.data("action-index"),this.adminController.log("Action clicked",t),this.actions[t]?"function"==typeof this.actions[t].callback&&this.actions[t].callback.call(this):this.adminController.warn('"'+t+'" is not a valid action.'),!1})),this.sections.widgets.on("click",".widget-group",(t=>{let i,s=$(t.currentTarget);this.adminController.log("Toggling visibility of group's widgets."),s.hasClass("closed")?(s.removeClass("closed"),i=!0):(s.addClass("closed"),i=!1),e=s.data("group"),$(".widget-group-"+e,this.sections.widgets).toggleClass("hidden"),window._nails_admin.localStorage.set("widgeteditor-group-"+e+"-hidden",!i)})).on("mouseenter",".widget",(t=>{let e=$(t.currentTarget),i=e.data("preview"),s=e.data("description");(i||s)&&(this.sections.preview.css("top",e.offset().top+10+"px").addClass("is-shown"),i?this.sections.preview.find("img").attr("src",i).show():this.sections.preview.find("img").hide(),this.sections.preview.find("small").html(s))})).on("mouseleave",".widget",(()=>{this.sections.preview.removeClass("is-shown")})),this.sections.search.on("keyup",(()=>{this.searchTimeout&&clearTimeout(this.searchTimeout),this.searchTimeout=setTimeout((()=>{let t=this.sections.search.find("input").val().trim();this.searchWidgets(t)}),this.searchDelay)})),this.sections.body.on("click",".action-remove",(t=>{let e=$(t.currentTarget).closest(".widget"),i=this.getWidget(e.data("slug"));this.confirm('Are you sure you wish to remove this "'+i.label+'" widget from the interface?').done((()=>{this.adminController.log("Removing Widget"),e.remove(),i.callbacks.removed.call(this,e)}))})),this.sections.body.on("click",".action-refresh-editor",(t=>{let e=$(t.currentTarget).closest(".widget"),i=e.data("slug"),s=e.find(":input").serializeObject();e.data("original-data",s).data("loaded",!1).addClass("editor-loading").find(".editor-target").removeClass("alert alert-danger").empty().text("Widget Loading..."),this.setupWidgetEditor(i,s,e)})),$(document).on("keyup",(t=>{this.isOpen()&&t.which===this.keymap.ESC&&this.actionClose()})),this}loadSidebarWidgets(){let t,e,i,s,a,d;return this.adminController.log("Fetching available CMS widgets"),t=$.Deferred(),$.ajax({url:window.SITE_URL+"api/cms/widgets/index"}).done((r=>{for(this.adminController.log("Succesfully fetched widgets from the server."),this.widgets=r.data.widgets,e=this.widgets.length-1;e>=0;e--)for(i=this.widgets[e].widgets.length-1;i>=0;i--)for(s in this.widgets[e].widgets[i].callbacks)this.widgets[e].widgets[i].callbacks.hasOwnProperty(s)&&(this.widgets[e].widgets[i].callbacks[s]=new Function("domElement",this.widgets[e].widgets[i].callbacks[s]));for(a="",e=0;e<r.data.assets.css.length;e++)a+=r.data.assets.css[e]+"\n";for(d="",e=0;e<r.data.assets.js.length;e++)d+=r.data.assets.js[e]+"\n";$("head").append(a),$("body").append(d),t.resolve()})).fail((()=>{this.adminController.warn("Failed to load widgets from the server."),t.reject()})),t}populateWidgetDataFromButtons(t){return t.each(((t,e)=>{let i=$(e).data("key"),s=$(e).siblings("textarea.widget-data");if(s.length)try{let t=JSON.parse(s.val());this.setAreaData(i,t)}catch(t){this.adminController.warn("Failed to parse JSON data"),this.adminController.warn(t.message)}})),this}renderSidebarWidgets(){let t,e,i,s,a,d;for(this.sections.widgets.empty(),t=0;t<this.widgets.length;t++){i=$("<span>").text(this.widgets[t].label),s=$("<i>").addClass("icon fa fa-chevron-up"),a=$("<div>").addClass("widget-group").data("group",t).append(i).append(s);let r=window._nails_admin.localStorage.get("widgeteditor-group-"+t+"-hidden");for(!0!==r&&null!==r||a.addClass("closed"),this.sections.widgets.append(a),e=0;e<this.widgets[t].widgets.length;e++)d=$("<i>").addClass("icon fa "+this.widgets[t].widgets[e].icon),i=$("<span>").text(this.widgets[t].widgets[e].label),a=$("<div>").addClass("widget widget-group-"+t).data("group",t).data("slug",this.widgets[t].widgets[e].slug).data("preview",this.widgets[t].widgets[e].screenshot).data("description",this.widgets[t].widgets[e].description).data("keywords",this.widgets[t].widgets[e].keywords),!0!==r&&null!==r||a.addClass("hidden"),a.append(d).append(i),this.sections.widgets.append(a)}return this}searchWidgets(t){let e,i,s,a;t.length>0?(this.adminController.log('Filtering widgets by term "'+t+'"'),this.sections.widgets.find(".widget").each(((a,d)=>{let r=$(d);for(e=r.data("keywords").split(","),i=e.length-1;i>=0;i--){if(s=new RegExp(t,"gi"),s.test(e[i]))return r.removeClass("search-hide"),void r.addClass("search-show");r.removeClass("search-show"),r.addClass("search-hide")}})),this.sections.widgets.find(".widget-group").each(((t,e)=>{let i=$(e);a=i.data("group"),$(".widget-group-"+a+".search-show").length?(i.removeClass("search-hide"),i.addClass("search-show")):(i.removeClass("search-show"),i.addClass("search-hide"))}))):(this.adminController.log("Restoring widgets"),this.sections.widgets.find(".widget, .widget-group").removeClass("search-show search-hide"))}addAction(t,e,i){return this.adminController.log('Adding action "'+t+'"'),this.actions.push({label:t,type:e,callback:i}),this.renderActions(),this}renderActions(){let t,e;for(this.sections.actions.empty(),t=this.actions.length-1;t>=0;t--)e=$("<a>").addClass("action btn btn-sm btn-"+this.actions[t].type).data("action-index",t).html(this.actions[t].label),this.sections.actions.append(e);return this}show(t){if(t=t||this.defaultArea,this.adminController.log('Showing Editor for "'+t+'"'),this.activeArea=t,this.sections.body.find("> ul").empty(),this.widgetData[t]&&this.widgetData[t].length){this.adminController.log("Adding previous widgets");let e=[],i=[];for(let s in this.widgetData[t])if(this.widgetData[t].hasOwnProperty(s)){let a=$("<div>").addClass("widget");this.sections.body.find("> ul").append(a),this.addWidget(this.widgetData[t][s].slug,this.widgetData[t][s].data,a,!0),e.push(a),i.push(this.widgetData[t][s])}this.adminController.log("Setting up all widgets"),$.ajax({url:window.SITE_URL+"api/cms/widgets/editors",method:"POST",data:{data:JSON.stringify(i)}}).done((t=>{let i,s;for(this.adminController.log("Succesfully fetched widget editors from the server."),i=0;i<t.data.length;i++)t.data[i].error?this.setupWidgetEditorFail(e[i],t.data[i].editor):this.setupWidgetEditorOk(e[i],t.data[i].editor);for(this.initWidgetEditorElements(),i=0;i<t.data.length;i++)s=this.getWidget(t.data[i].slug),s.callbacks.dropped.call(this,e[i])})).fail((t=>{let e;try{e=JSON.parse(t.responseText)}catch(t){e={status:500,error:"An unknown error occurred."}}this.adminController.warn("Failed to load widget editors from the server with error: ",e.error)}))}return this.draggableConstruct(),this.sortableConstruct(),this.container.addClass("active"),this.isEditorOpen=!0,$("body").addClass("noscroll"),this}close(){return this.adminController.log("Closing Editor"),this.container.removeClass("active"),this.isEditorOpen=!1,this.activeArea="",this.draggableDestroy(),this.sortableDestroy(),$("body").removeClass("noscroll"),$(this).trigger("widgeteditor-close"),this}draggableConstruct(){return this.sections.widgets.find(".widget").draggable({helper:"clone",connectToSortable:this.sections.body.find("> ul"),appendTo:this.container,zIndex:100}),this}draggableDestroy(){return this.sections.widgets.find(".widget.ui-draggable").draggable("destroy"),this}sortableConstruct(){return this.sections.body.find("> ul").sortable({placeholder:"sortable-placeholder",handle:".icon",axis:"y",start:(t,e)=>{e.helper.removeClass("hidden search-show search-hide"),e.placeholder.height(e.helper.outerHeight()),this.adminController.getInstance("Wysiwyg").destroy()},receive:(t,e)=>{let i,s,a;i=e.item,s=e.helper,a=i.data("slug"),s.removeClass("hidden search-show search-hide"),this.addWidget(a,null,s),s.removeAttr("style")},stop:(t,e)=>{this.adminController.refreshUi()}}),this}sortableDestroy(){let t=this.sections.body.find("> ul.ui-sortable");return t.length>0&&t.sortable("destroy"),this}addWidget(t,e,i,s){if("string"==typeof t&&(t=this.getWidget(t)),t)this.adminController.log('Adding Widget "'+t.slug+'" with data:',e),$(i).empty().data("original-data",e).data("loaded",!1).data("slug",t.slug).addClass("editor-loading").html(Mustache.render(this.sections.widget.html(),t)),s||this.setupWidgetEditor(t.slug,e,i);else{this.adminController.warn("Attempted to add an invalid widget");let e=$("<p>").addClass("alert alert-danger").html('Widget "'+t+'" does not exist. <a href="#" class="action-remove">Remove?</a>');$(i).empty().addClass("editor-missing").append(e)}return this}setupWidgetEditor(t,e,i){this.getWidgetEditor(t,e).done((e=>{this.adminController.log("Editor Received"),this.setupWidgetEditorOk(i,e),this.initWidgetEditorElements(i),this.getWidget(t).callbacks.dropped.call(this,i)})).fail((t=>{this.setupWidgetEditorFail(i,t.error)}))}setupWidgetEditorOk(t,e){t.data("loaded",!0).removeClass("editor-loading").find(".editor-target").html(e)}setupWidgetEditorFail(t,e){t.data("loaded",!1).removeClass("editor-loading").find(".editor-target").addClass("alert alert-danger").html("<strong>Error:</strong> "+e)}addWidgetInitCallback(t){return this.widgetInitCallback.push(t),this}initWidgetEditorElements(t){for(let e=0,i=this.widgetInitCallback.length;e<i;e++)this.widgetInitCallback[e].call(t)}getWidget(t){let e,i;for(e=this.widgets.length-1;e>=0;e--)for(i=this.widgets[e].widgets.length-1;i>=0;i--)if(this.widgets[e].widgets[i].slug===t)return this.widgets[e].widgets[i];return!1}getWidgetEditor(t,e){let i;return i=$.Deferred(),$.ajax({url:window.SITE_URL+"api/cms/widgets/editor",method:"POST",data:{slug:t,data:e}}).done((t=>{this.adminController.log("Successfully fetched widget editor from the server."),i.resolve(t.data.editor)})).fail((t=>{let e;try{e=JSON.parse(t.responseText)}catch(t){e={status:500,error:"An unknown error occurred."}}this.adminController.warn("Failed to load widget editor from the server with error: ",e.error),i.reject(e)})),i.promise()}getAreaData(t){t=t||this.defaultArea,this.adminController.log('Getting editor data for area "'+t+'"'),this.isOpen()&&t===this.activeArea&&(this.adminController.log("Editor is open with selected area, refreshing data"),this.widgetData[t]=this.getActiveData());let e=this.widgetData[t];return Array.isArray(e)&&0===e.length&&(e=null),e||null}setAreaData(t,e){return t=t||this.defaultArea,this.adminController.log('Setting editor data for area "'+t+'"',e),this.widgetData[t]=e,this}getActiveData(){let t,e=[];return this.adminController.log("Getting active editor's data"),t=this.sections.body.find("> ul > .widget"),t.each(((t,i)=>{let s=$(i);this.adminController.log("Serialising: "+$(i).data("slug")),s.data("loaded")?e.push({slug:s.data("slug"),data:s.find(":input").serializeObject()}):(this.adminController.log("Widget not in a ready-state, using cached data"),e.push({slug:s.data("slug"),data:s.data("original-data")}))})),e}actionClose(){this.widgetData[this.activeArea]=this.getActiveData(),this.close()}confirm(t,e){t=t||"Are you sure you wish to complete this action?",e=e||"Are you sure?";let i=$.Deferred();return setTimeout((function(){$("<div>").text(t).dialog({title:e,resizable:!1,draggable:!1,modal:!0,dialogClass:"group-cms widgeteditor-alert",buttons:{OK:function(){$(this).dialog("close"),i.resolve()},Cancel:function(){$(this).dialog("close"),i.reject()}}})}),10),i.promise()}isReady(){return this.isEditorReady}isOpen(){return this.isEditorOpen}}(t)}))})();