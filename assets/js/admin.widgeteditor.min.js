var NAILS_Admin_CMS_WidgetEditor;NAILS_Admin_CMS_WidgetEditor=function(){var e=this;return e.widgets=[],e.actions=[{label:'<i class="fa fa-lg fa-times"></i>',type:"danger",callback:function(){e.widgetData[e.activeArea]=e.getActiveData(),e.close()}}],e.widgetData={},e.container=null,e.sections={},e.isOpen=!1,e.activeArea="",e.defaultArea="default",e.searchTimeout=null,e.searchDelay=150,e.__construct=function(){return e.log("Constructing Widget Editor"),e.generateMarkup(),e.bindEvents(),e.loadSidebarWidgets().done(function(){e.renderSidebarWidgets()}),e},e.generateMarkup=function(){var t;return null===e.container?(e.log("Injecting editor markup"),e.container=$("<div>").addClass("group-cms widgeteditor"),e.sections={header:$("<div>").addClass("widgeteditor-header").text("Some header text, maybe"),actions:$("<div>").addClass("widgeteditor-actions"),search:$("<div>").addClass("widgeteditor-search"),widgets:$("<div>").addClass("widgeteditor-widgets"),body:$("<div>").addClass("widgeteditor-body").html('<ul></ul><div class="no-widgets">Drag widgets from the left to here</div>'),widget:$("<div>").html('<i class="icon fa {{icon}}"></i><span>{{label}}</span><a href="#" class="action action-remove fa fa-trash-o"></a><a href="#" class="action action-refresh-editor fa fa-refresh"></a><div class="description">{{description}}</div><div class="editor-target fieldset">Widget Loading...</div>')},t=$("<input>").attr("type","search").attr("placeholder","Search widgets"),e.sections.search.append(t),e.container.append(e.sections.header).append(e.sections.actions).append(e.sections.search).append(e.sections.widgets).append(e.sections.body),$("body").append(e.container),e.renderSidebarWidgets(),e.renderActions()):e.warn("Editor already generated"),e},e.bindEvents=function(){var t,i;return e.sections.actions.on("click",".action",function(){return t=$(this).data("action-index"),e.log("Action clicked",t),e.actions[t]?"function"==typeof e.actions[t].callback&&e.actions[t].callback.call(e):e.warn('"'+t+'" is not a valid action.'),!1}),e.sections.widgets.on("click",".widget-group",function(){e.log("Toggling visibility of group's widgets.");var t;$(this).hasClass("closed")?($(this).removeClass("closed"),t=!0):($(this).addClass("closed"),t=!1),i=$(this).data("group"),$(".widget-group-"+i,e.sections.widgets).toggleClass("hidden"),_nails_admin.localStorage.set("widgeteditor-group-"+i+"-hidden",!t)}),e.sections.search.on("keyup",function(){e.searchTimeout&&clearTimeout(e.searchTimeout),e.searchTimeout=setTimeout(function(){var t=e.sections.search.find("input").val().trim();e.searchWidgets(t)},e.searchDelay)}),e.sections.body.on("click",".action-remove",function(){var t=$(this).closest(".widget"),i=e.getWidget(t.data("slug"));e.confirm('Are you sure you wish to remove this "'+i.label+'" widget from the interface?').done(function(){e.log("Removing Widget"),t.remove(),i.callbacks.removed.call(e,t)})}),e.sections.body.on("click",".action-refresh-editor",function(){var t=$(this).closest(".widget"),i=t.data("slug"),a=t.find(":input").serializeObject();t.addClass("editor-loading").find(".editor-target").removeClass("alert alert-danger").empty().text("Widget Loading..."),e.setupWidgetEditor(i,a,t)}),e},e.loadSidebarWidgets=function(){var t,i,a,s,d,r;return e.log("Fetching available CMS widgets"),t=$.Deferred(),_nails_api.call({controller:"cms/widgets",method:"index",success:function(o){for(e.log("Succesfully fetched widgets from the server."),e.widgets=o.widgets,i=e.widgets.length-1;i>=0;i--)for(a=e.widgets[i].widgets.length-1;a>=0;a--)for(s in e.widgets[i].widgets[a].callbacks)e.widgets[i].widgets[a].callbacks.hasOwnProperty(s)&&(e.widgets[i].widgets[a].callbacks[s]=new Function("domElement",e.widgets[i].widgets[a].callbacks[s]));for(d="",i=0;i<o.assets.css.length;i++)d+=o.assets.css[i]+"\n";for(r="",i=0;i<o.assets.js.length;i++)r+=o.assets.js[i]+"\n";$("head").append(d),$("body").append(r),t.resolve()},error:function(){e.warn("Failed to load widgets from the server."),t.reject()}}),t},e.renderSidebarWidgets=function(){e.sections.widgets.empty();var t,i,a,s,d,r;for(t=0;t<e.widgets.length;t++){a=$("<span>").text(e.widgets[t].label),s=$("<i>").addClass("icon fa fa-chevron-down"),d=$("<div>").addClass("widget-group").data("group",t).append(a).append(s);var o=_nails_admin.localStorage.get("widgeteditor-group-"+t+"-hidden");for((o===!0||null===o)&&d.addClass("closed"),e.sections.widgets.append(d),i=0;i<e.widgets[t].widgets.length;i++)r=$("<i>").addClass("icon fa "+e.widgets[t].widgets[i].icon),a=$("<span>").text(e.widgets[t].widgets[i].label),d=$("<div>").addClass("widget widget-group-"+t).data("group",t).data("slug",e.widgets[t].widgets[i].slug).data("keywords",e.widgets[t].widgets[i].keywords),(o===!0||null===o)&&d.addClass("hidden"),d.append(r).append(a),e.sections.widgets.append(d)}return e},e.searchWidgets=function(t){var i,a,s,d;t.length>0?(e.log('Filtering widgets by term "'+t+'"'),e.sections.widgets.find(".widget").each(function(){for(i=$(this).data("keywords").split(","),a=i.length-1;a>=0;a--){if(s=new RegExp(t,"gi"),s.test(i[a]))return $(this).removeClass("search-hide"),void $(this).addClass("search-show");$(this).removeClass("search-show"),$(this).addClass("search-hide")}}),e.sections.widgets.find(".widget-group").each(function(){return d=$(this).data("group"),$(".widget-group-"+d+".search-show").length?($(this).removeClass("search-hide"),void $(this).addClass("search-show")):($(this).removeClass("search-show"),void $(this).addClass("search-hide"))})):(e.log("Restoring widgets"),e.sections.widgets.find(".widget, .widget-group").removeClass("search-show search-hide"))},e.addAction=function(t,i,a){return e.log('Adding action "'+t+'"'),e.actions.push({label:t,type:i,callback:a}),e.renderActions(),e},e.removeAction=function(t){return e.log('Removing action "'+t+'"'),e.renderActions(),e},e.renderActions=function(){var t,i;for(e.sections.actions.empty(),t=e.actions.length-1;t>=0;t--)i=$("<a>").addClass("action btn btn-sm btn-"+e.actions[t].type).data("action-index",t).html(e.actions[t].label),e.sections.actions.append(i);return e},e.show=function(t){if(t=t||e.defaultArea,e.log('Showing Editor for "'+t+'"'),e.activeArea=t,e.sections.body.find("> ul").empty(),e.widgetData[t]&&e.widgetData[t].length){e.log("Adding previous widgets");var i=[],a=[];for(var s in e.widgetData[t])if(e.widgetData[t].hasOwnProperty(s)){var d=$("<div>").addClass("widget");e.sections.body.find("> ul").append(d),e.addWidget(e.widgetData[t][s].slug,e.widgetData[t][s].data,d,!0),i.push(d),a.push(e.widgetData[t][s])}e.log("Setting up all widgets"),_nails_api.call({controller:"cms/widgets",method:"editors",action:"POST",data:{data:a},success:function(t){var a,s;for(e.log("Succesfully fetched widget editors from the server."),a=0;a<t.data.length;a++)t.data[a].error?e.setupWidgetEditorFail(i[a],t.data[a].editor):e.setupWidgetEditorOk(i[a],t.data[a].editor);for(e.initWidgetEditorElements(),a=0;a<t.data.length;a++)s=e.getWidget(t.data[a].slug),s.callbacks.dropped.call(e,i[a])},error:function(t){var i;try{i=JSON.parse(t.responseText)}catch(a){i={status:500,error:"An unknown error occurred."}}e.warn("Failed to load widget editors from the server with error: ",i.error)}})}return e.draggableConstruct(),e.sortableConstruct(),e.container.addClass("active"),e.isOpen=!0,$("body").addClass("noscroll"),e},e.close=function(){return e.log("Closing Editor"),e.container.removeClass("active"),e.isOpen=!1,e.activeArea="",e.draggableDestroy(),e.sortableDestroy(),$("body").removeClass("noscroll"),$(e).trigger("widgeteditor-close"),e},e.draggableConstruct=function(){return e.sections.widgets.find(".widget").draggable({helper:"clone",connectToSortable:e.sections.body.find("> ul"),appendTo:e.container,zIndex:100}),e},e.draggableDestroy=function(){return e.sections.widgets.find(".widget.ui-draggable").draggable("destroy"),e},e.sortableConstruct=function(){return e.sections.body.find("> ul").sortable({placeholder:"sortable-placeholder",handle:".icon",axis:"y",start:function(e,t){t.helper.removeClass("hidden search-show search-hide"),t.placeholder.height(t.helper.outerHeight()),_nails_admin.destroyWysiwyg("basic",t.helper),_nails_admin.destroyWysiwyg("default",t.helper)},receive:function(t,i){var a,s,d;a=i.item,s=i.helper,d=a.data("slug"),s.removeClass("hidden search-show search-hide"),e.addWidget(d,null,s),s.removeAttr("style")},stop:function(e,t){_nails_admin.buildWysiwyg("basic",t.helper),_nails_admin.buildWysiwyg("default",t.helper)}}),e},e.sortableDestroy=function(){var t=e.sections.body.find("> ul.ui-sortable");return t.length>0&&t.sortable("destroy"),e},e.addWidget=function(t,i,a,s){return"string"==typeof t&&(t=e.getWidget(t)),t?(e.log('Adding Widget "'+t.slug+'" with data:',i),$(a).empty().data("slug",t.slug).addClass("editor-loading").html(Mustache.render(e.sections.widget.html(),t)),s||e.setupWidgetEditor(t.slug,i,a)):e.warn("Attempted to add an invalid widget"),e},e.setupWidgetEditor=function(t,i,a){e.getWidgetEditor(t,i).done(function(i){e.log("Editor Received"),e.setupWidgetEditorOk(a,i),e.initWidgetEditorElements(a);var s=e.getWidget(t);s.callbacks.dropped.call(e,a)}).fail(function(t){e.setupWidgetEditorFail(a,t.error)})},e.setupWidgetEditorOk=function(e,t){e.removeClass("editor-loading").find(".editor-target").html(t)},e.setupWidgetEditorFail=function(e,t){e.removeClass("editor-loading").find(".editor-target").addClass("alert alert-danger").html("<strong>Error:</strong> "+t)},e.initWidgetEditorElements=function(e){_nails.addStripes(e),_nails_admin.buildWysiwyg("basic",e),_nails_admin.buildWysiwyg("default",e),_nails_admin.initSelect2(e),_nails_admin.initToggles(e),_nails.initTipsy(e)},e.getWidget=function(t){var i,a;for(i=e.widgets.length-1;i>=0;i--)for(a=e.widgets[i].widgets.length-1;a>=0;a--)if(e.widgets[i].widgets[a].slug===t)return e.widgets[i].widgets[a];return!1},e.getWidgetEditor=function(t,i){var a;return a=$.Deferred(),_nails_api.call({controller:"cms/widgets",method:"editor",action:"POST",data:{slug:t,data:i},success:function(t){e.log("Succesfully fetched widget editor from the server."),a.resolve(t.editor)},error:function(t){var i;try{i=JSON.parse(t.responseText)}catch(s){i={status:500,error:"An unknown error occurred."}}e.warn("Failed to load widget editor from the server with error: ",i.error),a.reject(i)}}),a.promise()},e.getAreaData=function(t){return t=t||e.defaultArea,e.log('Getting editor data for area "'+t+'"'),e.isOpen&&t===e.activeArea&&(e.log("Editor is open with selected area, refreshing data"),e.widgetData[t]=e.getActiveData()),e.widgetData[t]||null},e.setAreaData=function(t,i){return t=t||e.defaultArea,e.log('Setting editor data for area "'+t+'"',i),e.widgetData[t]=i,e},e.getActiveData=function(){var t,i=[];return e.log("Getting active editor's data"),t=e.sections.body.find("> ul > .widget"),t.each(function(){i.push({slug:$(this).data("slug"),data:$(this).find(":input").serializeObject()})}),i},e.confirm=function(e,t){e=e?e:"Are you sure you wish to complete this action?",t=t?t:"Are you sure?";var i=$.Deferred();return $("<div>").text(e).dialog({title:t,resizable:!1,draggable:!1,modal:!0,dialogClass:"group-cms widgeteditor-alert",buttons:{OK:function(){$(this).dialog("close"),i.resolve()},Cancel:function(){$(this).dialog("close"),i.reject()}}}),i.promise()},e.log=function(t,i){return"function"==typeof console.log&&(void 0!==i?console.log("CMS Widget Editor:",t,i):console.log("CMS Widget Editor:",t)),e},e.warn=function(t,i){return"function"==typeof console.warn&&(void 0!==i?console.warn("CMS Widget Editor:",t,i):console.warn("CMS Widget Editor:",t)),e},e.__construct()};
//# sourceMappingURL=admin.widgeteditor.min.js.map
