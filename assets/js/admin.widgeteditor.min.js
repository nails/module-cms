var NAILS_Admin_CMS_WidgetEditor;NAILS_Admin_CMS_WidgetEditor=function(){var e=this;return this.ready=!1,this.widgets=[],this.actions=[{label:'<i class="fa fa-lg fa-check"></i>',type:"success",callback:function(){e.actionClose()}}],this.widgetData={},this.container=null,this.sections={},this.isOpen=!1,this.activeArea="",this.defaultArea="default",this.searchTimeout=null,this.searchDelay=150,this.keymap={ESC:27},this.__construct=function(){return e.log("Constructing Widget Editor"),e.generateMarkup(),e.bindEvents(),e.loadSidebarWidgets().done(function(){e.renderSidebarWidgets(),e.ready=!0,e.log("Widget Editor ready")}),e},this.generateMarkup=function(){var t;return null===e.container?(e.log("Injecting editor markup"),e.container=$("<div>").addClass("group-cms widgeteditor"),e.sections={header:$("<div>").addClass("widgeteditor-header").text("Some header text, maybe"),actions:$("<div>").addClass("widgeteditor-actions"),search:$("<div>").addClass("widgeteditor-search"),widgets:$("<div>").addClass("widgeteditor-widgets"),body:$("<div>").addClass("widgeteditor-body").html('<ul></ul><div class="no-widgets">Drag widgets from the left to here</div>'),widget:$("<div>").html('<i class="icon fa {{icon}}"></i><span>{{label}}</span><a href="#" class="action action-remove fa fa-trash-o"></a><a href="#" class="action action-refresh-editor fa fa-refresh"></a><div class="description">{{description}}</div><div class="editor-target fieldset">Widget Loading...</div>'),preview:$("<div>").addClass("widgeteditor-preview").html('<img width="250"><small></small>')},t=$("<input>").attr("type","search").attr("placeholder","Search widgets"),e.sections.search.append(t),e.container.append(e.sections.header).append(e.sections.actions).append(e.sections.search).append(e.sections.widgets).append(e.sections.body).append(e.sections.preview),$("body").append(e.container),e.renderSidebarWidgets(),e.renderActions()):e.warn("Editor already generated"),e},this.bindEvents=function(){var t,i;return e.sections.actions.on("click",".action",function(){return t=$(this).data("action-index"),e.log("Action clicked",t),e.actions[t]?"function"==typeof e.actions[t].callback&&e.actions[t].callback.call(e):e.warn('"'+t+'" is not a valid action.'),!1}),e.sections.widgets.on("click",".widget-group",function(){e.log("Toggling visibility of group's widgets.");var t;$(this).hasClass("closed")?($(this).removeClass("closed"),t=!0):($(this).addClass("closed"),t=!1),i=$(this).data("group"),$(".widget-group-"+i,e.sections.widgets).toggleClass("hidden"),_nails_admin.localStorage.set("widgeteditor-group-"+i+"-hidden",!t)}).on("mouseenter",".widget",function(){var t=$(this).data("preview"),i=$(this).data("description");(t||i)&&(e.sections.preview.css("top",$(this).offset().top+10+"px").addClass("is-shown"),t?e.sections.preview.find("img").attr("src",t).show():e.sections.preview.find("img").hide(),e.sections.preview.find("small").html(i))}).on("mouseleave",".widget",function(){e.sections.preview.removeClass("is-shown")}),e.sections.search.on("keyup",function(){e.searchTimeout&&clearTimeout(e.searchTimeout),e.searchTimeout=setTimeout(function(){var t=e.sections.search.find("input").val().trim();e.searchWidgets(t)},e.searchDelay)}),e.sections.body.on("click",".action-remove",function(){var t=$(this).closest(".widget"),i=e.getWidget(t.data("slug"));e.confirm('Are you sure you wish to remove this "'+i.label+'" widget from the interface?').done(function(){e.log("Removing Widget"),t.remove(),i.callbacks.removed.call(e,t)})}),e.sections.body.on("click",".action-refresh-editor",function(){var t=$(this).closest(".widget"),i=t.data("slug"),s=t.find(":input").serializeObject();t.addClass("editor-loading").find(".editor-target").removeClass("alert alert-danger").empty().text("Widget Loading..."),e.setupWidgetEditor(i,s,t)}),$(document).on("keyup",function(t){e.isOpen&&t.which===e.keymap.ESC&&e.actionClose()}),e},this.loadSidebarWidgets=function(){var t,i,s,a,d,o;return e.log("Fetching available CMS widgets"),t=$.Deferred(),_nails_api.call({controller:"cms/widgets",method:"index",success:function(r){for(e.log("Succesfully fetched widgets from the server."),e.widgets=r.widgets,i=e.widgets.length-1;i>=0;i--)for(s=e.widgets[i].widgets.length-1;s>=0;s--)for(a in e.widgets[i].widgets[s].callbacks)e.widgets[i].widgets[s].callbacks.hasOwnProperty(a)&&(e.widgets[i].widgets[s].callbacks[a]=new Function("domElement",e.widgets[i].widgets[s].callbacks[a]));for(d="",i=0;i<r.assets.css.length;i++)d+=r.assets.css[i]+"\n";for(o="",i=0;i<r.assets.js.length;i++)o+=r.assets.js[i]+"\n";$("head").append(d),$("body").append(o),t.resolve()},error:function(){e.warn("Failed to load widgets from the server."),t.reject()}}),t},this.renderSidebarWidgets=function(){e.sections.widgets.empty();var t,i,s,a,d,o;for(t=0;t<e.widgets.length;t++){s=$("<span>").text(e.widgets[t].label),a=$("<i>").addClass("icon fa fa-chevron-up"),d=$("<div>").addClass("widget-group").data("group",t).append(s).append(a);var r=_nails_admin.localStorage.get("widgeteditor-group-"+t+"-hidden");for(r!==!0&&null!==r||d.addClass("closed"),e.sections.widgets.append(d),i=0;i<e.widgets[t].widgets.length;i++)o=$("<i>").addClass("icon fa "+e.widgets[t].widgets[i].icon),s=$("<span>").text(e.widgets[t].widgets[i].label),d=$("<div>").addClass("widget widget-group-"+t).data("group",t).data("slug",e.widgets[t].widgets[i].slug).data("preview",e.widgets[t].widgets[i].screenshot).data("description",e.widgets[t].widgets[i].description).data("keywords",e.widgets[t].widgets[i].keywords),r!==!0&&null!==r||d.addClass("hidden"),d.append(o).append(s),e.sections.widgets.append(d)}return e},this.searchWidgets=function(t){var i,s,a,d;t.length>0?(e.log('Filtering widgets by term "'+t+'"'),e.sections.widgets.find(".widget").each(function(){for(i=$(this).data("keywords").split(","),s=i.length-1;s>=0;s--){if(a=new RegExp(t,"gi"),a.test(i[s]))return $(this).removeClass("search-hide"),void $(this).addClass("search-show");$(this).removeClass("search-show"),$(this).addClass("search-hide")}}),e.sections.widgets.find(".widget-group").each(function(){d=$(this).data("group"),$(".widget-group-"+d+".search-show").length?($(this).removeClass("search-hide"),$(this).addClass("search-show")):($(this).removeClass("search-show"),$(this).addClass("search-hide"))})):(e.log("Restoring widgets"),e.sections.widgets.find(".widget, .widget-group").removeClass("search-show search-hide"))},this.addAction=function(t,i,s){return e.log('Adding action "'+t+'"'),e.actions.push({label:t,type:i,callback:s}),e.renderActions(),e},this.renderActions=function(){var t,i;for(e.sections.actions.empty(),t=e.actions.length-1;t>=0;t--)i=$("<a>").addClass("action btn btn-sm btn-"+e.actions[t].type).data("action-index",t).html(e.actions[t].label),e.sections.actions.append(i);return e},this.show=function(t){if(t=t||e.defaultArea,e.log('Showing Editor for "'+t+'"'),e.activeArea=t,e.sections.body.find("> ul").empty(),e.widgetData[t]&&e.widgetData[t].length){e.log("Adding previous widgets");var i=[],s=[];for(var a in e.widgetData[t])if(e.widgetData[t].hasOwnProperty(a)){var d=$("<div>").addClass("widget");e.sections.body.find("> ul").append(d),e.addWidget(e.widgetData[t][a].slug,e.widgetData[t][a].data,d,!0),i.push(d),s.push(e.widgetData[t][a])}e.log("Setting up all widgets"),_nails_api.call({controller:"cms/widgets",method:"editors",action:"POST",data:{data:s},success:function(t){var s,a;for(e.log("Succesfully fetched widget editors from the server."),s=0;s<t.data.length;s++)t.data[s].error?e.setupWidgetEditorFail(i[s],t.data[s].editor):e.setupWidgetEditorOk(i[s],t.data[s].editor);for(e.initWidgetEditorElements(),s=0;s<t.data.length;s++)a=e.getWidget(t.data[s].slug),a.callbacks.dropped.call(e,i[s])},error:function(t){var i;try{i=JSON.parse(t.responseText)}catch(s){i={status:500,error:"An unknown error occurred."}}e.warn("Failed to load widget editors from the server with error: ",i.error)}})}return e.draggableConstruct(),e.sortableConstruct(),e.container.addClass("active"),e.isOpen=!0,$("body").addClass("noscroll"),e},this.close=function(){return e.log("Closing Editor"),e.container.removeClass("active"),e.isOpen=!1,e.activeArea="",e.draggableDestroy(),e.sortableDestroy(),$("body").removeClass("noscroll"),$(e).trigger("widgeteditor-close"),e},this.draggableConstruct=function(){return e.sections.widgets.find(".widget").draggable({helper:"clone",connectToSortable:e.sections.body.find("> ul"),appendTo:e.container,zIndex:100}),e},this.draggableDestroy=function(){return e.sections.widgets.find(".widget.ui-draggable").draggable("destroy"),e},this.sortableConstruct=function(){return e.sections.body.find("> ul").sortable({placeholder:"sortable-placeholder",handle:".icon",axis:"y",start:function(e,t){t.helper.removeClass("hidden search-show search-hide"),t.placeholder.height(t.helper.outerHeight()),_nails_admin.destroyWysiwyg("basic",t.helper),_nails_admin.destroyWysiwyg("default",t.helper)},receive:function(t,i){var s,a,d;s=i.item,a=i.helper,d=s.data("slug"),a.removeClass("hidden search-show search-hide"),e.addWidget(d,null,a),a.removeAttr("style")},stop:function(e,t){_nails_admin.buildWysiwyg("basic",t.helper),_nails_admin.buildWysiwyg("default",t.helper)}}),e},this.sortableDestroy=function(){var t=e.sections.body.find("> ul.ui-sortable");return t.length>0&&t.sortable("destroy"),e},this.addWidget=function(t,i,s,a){return"string"==typeof t&&(t=e.getWidget(t)),t?(e.log('Adding Widget "'+t.slug+'" with data:',i),$(s).empty().data("slug",t.slug).addClass("editor-loading").html(Mustache.render(e.sections.widget.html(),t)),a||e.setupWidgetEditor(t.slug,i,s)):e.warn("Attempted to add an invalid widget"),e},this.setupWidgetEditor=function(t,i,s){e.getWidgetEditor(t,i).done(function(i){e.log("Editor Received"),e.setupWidgetEditorOk(s,i),e.initWidgetEditorElements(s);var a=e.getWidget(t);a.callbacks.dropped.call(e,s)}).fail(function(t){e.setupWidgetEditorFail(s,t.error)})},this.setupWidgetEditorOk=function(e,t){e.removeClass("editor-loading").find(".editor-target").html(t)},this.setupWidgetEditorFail=function(e,t){e.removeClass("editor-loading").find(".editor-target").addClass("alert alert-danger").html("<strong>Error:</strong> "+t)},this.initWidgetEditorElements=function(e){_nails.addStripes(),_nails_admin.buildWysiwyg("basic",e),_nails_admin.buildWysiwyg("default",e),_nails_admin.initSelect2(),_nails_admin.initToggles(),_nails.initTipsy()},this.getWidget=function(t){var i,s;for(i=e.widgets.length-1;i>=0;i--)for(s=e.widgets[i].widgets.length-1;s>=0;s--)if(e.widgets[i].widgets[s].slug===t)return e.widgets[i].widgets[s];return!1},this.getWidgetEditor=function(t,i){var s;return s=$.Deferred(),_nails_api.call({controller:"cms/widgets",method:"editor",action:"POST",data:{slug:t,data:i},success:function(t){e.log("Successfully fetched widget editor from the server."),s.resolve(t.editor)},error:function(t){var i;try{i=JSON.parse(t.responseText)}catch(a){i={status:500,error:"An unknown error occurred."}}e.warn("Failed to load widget editor from the server with error: ",i.error),s.reject(i)}}),s.promise()},this.getAreaData=function(t){return t=t||e.defaultArea,e.log('Getting editor data for area "'+t+'"'),e.isOpen&&t===e.activeArea&&(e.log("Editor is open with selected area, refreshing data"),e.widgetData[t]=e.getActiveData()),e.widgetData[t]||null},this.setAreaData=function(t,i){return t=t||e.defaultArea,e.log('Setting editor data for area "'+t+'"',i),e.widgetData[t]=i,e},this.getActiveData=function(){var t,i=[];return e.log("Getting active editor's data"),t=e.sections.body.find("> ul > .widget"),t.each(function(){i.push({slug:$(this).data("slug"),data:$(this).find(":input").serializeObject()})}),i},this.actionClose=function(){e.widgetData[e.activeArea]=e.getActiveData(),e.close()},this.confirm=function(e,t){e=e?e:"Are you sure you wish to complete this action?",t=t?t:"Are you sure?";var i=$.Deferred();return $("<div>").text(e).dialog({title:t,resizable:!1,draggable:!1,modal:!0,dialogClass:"group-cms widgeteditor-alert",buttons:{OK:function(){$(this).dialog("close"),i.resolve()},Cancel:function(){$(this).dialog("close"),i.reject()}}}),i.promise()},this.log=function(t,i){return"function"==typeof console.log&&(void 0!==i?console.log("CMS Widget Editor:",t,i):console.log("CMS Widget Editor:",t)),e},this.warn=function(t,i){return"function"==typeof console.warn&&(void 0!==i?console.warn("CMS Widget Editor:",t,i):console.warn("CMS Widget Editor:",t)),e},e.__construct()};
//# sourceMappingURL=admin.widgeteditor.min.js.map
